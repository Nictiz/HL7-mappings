<?xml version="1.0" encoding="UTF-8"?>
<!-- Apache ANT build file that sets up (target = setup) or by default converts transaction with references to full ada xml (target = resolve-refs)
    Apache ANT is based on Java and may be found here: https://ant.apache.org/
    run on command line or from a batch file: 
        ant [-f build.xml] [target]
        
    If you just run ant, it expects a build.xml in the working dir and runs the default target.
-->
<project basedir="." name="build-ada2hl7-mp-930" xmlns:if="ant:if" xmlns:unless="ant:unless">
    <!-- These days most processing is done using yatc, however the validation no longer works in yatc due to duplicate schematron variable names -->
    <!-- The suggested 'fix' for that did now work either, and support stopped there until we generate new schematrons which hopefully no longer have this problem -->
    <!-- Therefore reinstated the ant validation scripts, so we could at least still do validation -->
    
    <property name="is.version" value="9.3.0"/>
    <property name="is.version.short" value="93"/>
    <property name="date.T" value="2023-01-01"/>

    <!-- place import after properties above, otherwise it can't resolve these properties  -->
    <import file="../../../_ant-buildfiles/ant-publish/build-ada2hl7-mp-include.xml"/>

    <property name="gen.schematron.ref" value="false"/>
    <property name="usecase.nt" value="nictiz_test"/>

    <!--    <property name="validate.dir" value="${build.dir}/../../../../../../SVN/AORTA/branches/Onderhoud_Mp_v90/Publicaties/20210931/mp-xml-20210921T194523/schematron_closed_warnings"/>-->
    <property name="validate.dir" value="${build.dir}/../../../../../../SVN/AORTA/trunk/Zorgtoepassing/Medicatieproces/DECOR/mp-runtime-develop"/>

    <property name="schema.organizer" value="${build.dir}/../../../../../../SVN/AORTA/branches/Onderhoud_Mp_v90/Publicaties/20231017/mp-xml-20231017T223005/schemas_codeGen_flat/organizer.xsd"/>
    <property name="schema.cda" value="${build.dir}/../../../../../../SVN/AORTA/branches/Onderhoud_Mp_v90/Publicaties/20231017/mp-xml-20231017T223005/schemas_codeGen_flat/CDANL_extended.xsd"/>

    <property name="xsl.validate.svrl" value="${build.dir}/../../../../YATC-shared/xsl/util/validate-svrl-output.xsl"/>

  
    <target name="schemavalidate_hl7_930">

        <!-- all use cases hl7_instance-->
        <antcall target="schemavalidate_hl7_sub">
            <param name="fileset.include" value="**/hl7_instance/*.xml"/>
            <param name="fileset.exclude" value="nictiz_test/**/*"/>
            <param name="validate.schema" value="${schema.organizer}"/>
        </antcall>

        <antcall target="schemavalidate_hl7_sub">
            <param name="fileset.include" value="**/hl7_instance_repo/*.xml"/>
            <param name="fileset.exclude" value="nictiz_test/**/*"/>
            <param name="validate.schema" value="${schema.organizer}"/>
        </antcall>

        <!-- all use cases cda_instance-->
        <antcall target="schemavalidate_hl7_sub">
            <param name="fileset.include" value="**/cda_instance/*.xml"/>
            <param name="fileset.exclude" value="nictiz_test/**/*"/>
            <param name="validate.schema" value="${schema.cda}"/>
        </antcall>

    </target>

    <target name="schematronvalidate_hl7_930">

        <!-- first the schematrons per instance -->
        <antcall target="validate_hl7_930"/>
        <!-- then summarize the results per use case -->
        <antcall target="schematronresults_hl7_930"/>

    </target>
    
    <target name="schematronresults_hl7_930_nictiztest">
        <!-- nictiz_test -->
        <antcall target="schematronresults_hl7_930_sub">
            <param name="result.xml" value="${build.dir}/validate/hl7_nictiz_test.xml"/>
            <param name="input.dir" value="../../../HL7-mappings/ada_2_hl7/${is.abbreviation}/${is.version}/nictiz_test/validate_hl7_instance"/>
            <param name="input.fileset" value="*.xml"/>
        </antcall>        
    </target>

    <target name="schematronresults_hl7_930">

        <!-- look at the results from target schematronvalidate_hl7_930 for conclusions -->
        <!-- beschikbaarstellen_medicatiegegevens -->
        <antcall target="schematronresults_hl7_930_sub">
            <param name="result.xml" value="${build.dir}/validate/hl7_${usecase.mg}.xml"/>
            <param name="input.dir" value="../../../HL7-mappings/ada_2_hl7/${is.abbreviation}/${is.version}/${usecase.mg}/validate_hl7_instance_repo"/>
            <param name="input.fileset" value="*.xml"/>
        </antcall>

        <!-- look at the results from target schematronvalidate_hl7_930 for conclusions -->
        <!-- sturen_medicatiegegevens -->
        <antcall target="schematronresults_hl7_930_sub">
            <param name="result.xml" value="${build.dir}/validate/hl7_${usecase.mg.st}.xml"/>
            <param name="input.dir" value="../../../HL7-mappings/ada_2_hl7/${is.abbreviation}/${is.version}/${usecase.mg.st}/validate_hl7_instance"/>
            <param name="input.fileset" value="*.xml"/>
        </antcall>
        
        <!-- sturen_afhandeling_medicatievoorschrift -->
        <antcall target="schematronresults_hl7_930_sub">
            <param name="result.xml" value="${build.dir}/validate/hl7_${usecase.av}.xml"/>
            <param name="input.dir" value="../../../HL7-mappings/ada_2_hl7/${is.abbreviation}/${is.version}/${usecase.av}/validate_hl7_instance"/>
            <param name="input.fileset" value="*.xml"/>
        </antcall>
        <!-- sturen_medicatievoorschrift hl7 organizer -->
        <antcall target="schematronresults_hl7_930_sub">
            <param name="result.xml" value="${build.dir}/validate/hl7_${usecase.mv}.xml"/>
            <param name="input.dir" value="../../../HL7-mappings/ada_2_hl7/${is.abbreviation}/${is.version}/${usecase.mv}/validate_hl7_instance"/>
            <param name="input.fileset" value="*.xml"/>
        </antcall>
        <!-- sturen_voorstel_medicatieafspraak -->
        <antcall target="schematronresults_hl7_930_sub">
            <param name="result.xml" value="${build.dir}/validate/hl7_${usecase.vma}.xml"/>
            <param name="input.dir" value="../../../HL7-mappings/ada_2_hl7/${is.abbreviation}/${is.version}/${usecase.vma}/validate_hl7_instance"/>
            <param name="input.fileset" value="*.xml"/>
        </antcall>
        <!-- sturen_antwoord_voorstel_medicatieafspraak -->
        <antcall target="schematronresults_hl7_930_sub">
            <param name="result.xml" value="${build.dir}/validate/hl7_${usecase.avma}.xml"/>
            <param name="input.dir" value="../../../HL7-mappings/ada_2_hl7/${is.abbreviation}/${is.version}/${usecase.avma}/validate_hl7_instance"/>
            <param name="input.fileset" value="*.xml"/>
        </antcall>
        <!-- sturen_voorstel_verstrekkingsverzoek -->
        <antcall target="schematronresults_hl7_930_sub">
            <param name="result.xml" value="${build.dir}/validate/hl7_${usecase.vvv}.xml"/>
            <param name="input.dir" value="../../../HL7-mappings/ada_2_hl7/${is.abbreviation}/${is.version}/${usecase.vvv}/validate_hl7_instance"/>
            <param name="input.fileset" value="*.xml"/>
        </antcall>
        <!-- sturen_antwoord_voorstel_verstrekkingsverzoek -->
        <antcall target="schematronresults_hl7_930_sub">
            <param name="result.xml" value="${build.dir}/validate/hl7_${usecase.avvv}.xml"/>
            <param name="input.dir" value="../../../HL7-mappings/ada_2_hl7/${is.abbreviation}/${is.version}/${usecase.avvv}/validate_hl7_instance"/>
            <param name="input.fileset" value="*.xml"/>
        </antcall>
        <!-- nictiz_test -->
        <antcall target="schematronresults_hl7_930_nictiztest"/>        
        <!-- xml voorbeelden organizer -->
        <antcall target="schematronresults_hl7_930_sub">
            <param name="result.xml" value="${build.dir}/validate/hl7_xml_voorbeelden.xml"/>
            <param name="input.dir" value="../../../HL7-mappings/ada_2_hl7/${is.abbreviation}/${is.version}/xml-voorbeelden/validate_hl7_instance"/>
            <param name="input.fileset" value="*.xml"/>
        </antcall>

    </target>

    <target name="schematronresults_hl7_930_sub">

        <echo/>
        <echo>${echo.label} ${xsl.validate.svrl} make recap of validation in ${result.xml}</echo>
        <xslt force="true" style="${xsl.validate.svrl}" in="${xsl.validate.svrl}" out="${result.xml}">
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
            <param name="inputDir" expression="${input.dir}"/>
            <param name="inputFileSet" expression="${input.fileset}"/>
        </xslt>

    </target>
    
    <target name="schematronvalidate_hl7_930_nictiztest">
        <!-- nictiz_test -->
        <echo/>
        <echo>${echo.label} nictiz_test</echo>
        <xslt force="true" style="${validate.dir}/mp-mp93_mgb_svrl.xsl" destdir="${build.dir}/nictiz_test/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/nictiz_test/hl7_instance" includes="mg-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>        
        <xslt force="true" style="${validate.dir}/mp-mp93_av_svrl.xsl" destdir="${build.dir}/nictiz_test/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/nictiz_test/hl7_instance" includes="av-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_vos_svrl.xsl" destdir="${build.dir}/nictiz_test/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/nictiz_test/hl7_instance" includes="mv-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <!-- and results nictiz_test -->
        <antcall target="schematronresults_hl7_930_nictiztest"/>        
        
    </target>

    <target name="validate_hl7_930">

        <!-- beschikbaarstellen_medicatiegegevens -->
        <antcall target="validate_hl7_sub">
            <param name="sub.build.dir" value="${build.dir}/${usecase.mg}"/>
            <param name="xsl.input" value="hl7_instance_repo"/>
            <param name="xsl.output" value="validate_hl7_instance_repo"/>
            <param name="xsl.mp" value="${validate.dir}/mp-mp93_mgb_svrl.xsl"/>
        </antcall>
        
        <!-- sturen_medicatiegegevens -->
        <antcall target="validate_hl7_sub">
            <param name="sub.build.dir" value="${build.dir}/${usecase.mg.st}"/>
            <param name="xsl.input" value="hl7_instance"/>
            <param name="xsl.output" value="validate_hl7_instance"/>
            <param name="xsl.mp" value="${validate.dir}/mp-mp93_mgb_svrl.xsl"/>
        </antcall>

        <!-- sturen_afhandeling_medicatievoorschrift -->
        <antcall target="validate_hl7_sub">
            <param name="sub.build.dir" value="${build.dir}/${usecase.av}"/>
            <param name="xsl.input" value="hl7_instance"/>
            <param name="xsl.output" value="validate_hl7_instance"/>
            <param name="xsl.mp" value="${validate.dir}/mp-mp93_av_svrl.xsl"/>
        </antcall>

        <!-- sturen_antwoord_voorstel_verstrekkingsverzoek -->
        <antcall target="validate_hl7_sub">
            <param name="sub.build.dir" value="${build.dir}/${usecase.avvv}"/>
            <param name="xsl.input" value="hl7_instance"/>
            <param name="xsl.output" value="validate_hl7_instance"/>
            <param name="xsl.mp" value="${validate.dir}/mp-mp93_avvv_svrl.xsl"/>
        </antcall>

        <!-- sturen_medicatievoorschrift -->
        <antcall target="validate_hl7_sub">
            <param name="sub.build.dir" value="${build.dir}/${usecase.mv}"/>
            <param name="xsl.input" value="hl7_instance"/>
            <param name="xsl.output" value="validate_hl7_instance"/>
            <param name="xsl.mp" value="${validate.dir}/mp-mp93_vos.xsl"/>
        </antcall>

        <!-- sturen_voorstel_medicatieafspraak -->
        <antcall target="validate_hl7_sub">
            <param name="sub.build.dir" value="${build.dir}/${usecase.vma}"/>
            <param name="xsl.input" value="hl7_instance"/>
            <param name="xsl.output" value="validate_hl7_instance"/>
            <param name="xsl.mp" value="${validate.dir}/mp-mp93_vma.xsl"/>
        </antcall>
        <!-- sturen_antwoord_voorstel_medicatieafspraak -->
        <antcall target="validate_hl7_sub">
            <param name="sub.build.dir" value="${build.dir}/${usecase.avma}"/>
            <param name="xsl.input" value="hl7_instance"/>
            <param name="xsl.output" value="validate_hl7_instance"/>
            <param name="xsl.mp" value="${validate.dir}/mp-mp93_avma.xsl"/>
        </antcall>

        <!-- sturen_voorstel_verstrekkingsverzoek -->
        <antcall target="validate_hl7_sub">
            <param name="sub.build.dir" value="${build.dir}/${usecase.vvv}"/>
            <param name="xsl.input" value="hl7_instance"/>
            <param name="xsl.output" value="validate_hl7_instance"/>
            <param name="xsl.mp" value="${validate.dir}/mp-mp93_vvv.xsl"/>
        </antcall>

        <!-- nictiz_test -->
        <antcall target="schematronvalidate_hl7_930_nictiztest"/>        
        
        <!-- xml-voorbeelden -->
        <echo/>
        <echo>${echo.label} xml-voorbeelden hl7_instance</echo>
        <xslt force="true" style="${validate.dir}/mp-mp93_mgb_svrl.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="mg-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_av_svrl.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="av-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_avvv_svrl.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="avvv-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_vos.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="mv-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_vma.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="vma-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_avma.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="avma-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_vvv.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="vvv-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>

        <echo/>
        <echo>${echo.label} xml-voorbeelden bouwstenen hl7_instance</echo>
                <xslt force="true" style="${validate.dir}/mp-mp93_mg_ma.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="bsma-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_mg_wds.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="bswds-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_mg_vv.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="bsvv-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_mg_ta.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="bsta-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_mg_mve.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="bsmve-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_mg_mgb.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="bsmgb-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>
        <xslt force="true" style="${validate.dir}/mp-mp93_mg_mtd.xsl" destdir="${build.dir}/xml-voorbeelden/validate_hl7_instance" extension=".xml" useImplicitFileset="false">
            <fileset dir="${build.dir}/xml-voorbeelden/hl7_instance" includes="bsmtd-*.xml"/>
            <factory name="${xsl.saxon.class}"/>
            <classpath location="${xsl.saxon}"/>
        </xslt>

    </target>
    
 </project>
